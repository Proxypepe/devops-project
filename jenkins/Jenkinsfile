pipeline {
    agent none


    environment {   
        REGESTRY_URL = "dockerregistry.local:5000"
        DOCKER_IMAGE_NAME = "flask-app-devops"
        TAG = "monitoring"
    }

    stages {
        stage("Test configurations") {
            agent { label 'slave' }
            steps {
                sh 'ansible-lint ansible/'
            }
        }

        stage("Working with code") {
            agent { label 'slave' }
            steps {
                sh 'flake8 src/'
            }     
        }

        stage('Build image') {
            agent { label 'master' }
            steps {
                def app = docker.build("${DOCKER_IMAGE_NAME}:${TAG}")
            }
        }
 
        stage('Test image') {
            agent { label 'master' }
            steps {
                app.inside {
                    sh 'echo "Tests passed"'
                }
            }
        }
        
        stage('Push image') {
            agent { label 'master' }
            // steps {
            //     docker.withRegistry("http://dockerregistry.local") {
            //         app.push("${version}")
            //     }
            // }
            steps {
                env.WORKSPACE = pwd()
                def version = readFile "${env.WORKSPACE}/.build-version"
                sh 'echo "${version}"'
            }
            
        }
    }
}
