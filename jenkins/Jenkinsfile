pipeline {
    agent none

    environment {   
        REGESTRY_URL = "dockerregistry.local:5000"
        DOCKER_IMAGE_NAME = "flask-app-devops"
        TAG = "monitoring"
    }

    stages {
        

        stage("Test configurations") {
            agent { label 'slave' }
            steps {
                sh 'ansible-lint ansible/'
            }
        }

        stage("Working with code") {
            agent { label 'slave' }
            steps {
                sh 'flake8 src/'
            }     
        }

        stage('Build image') {
            agent { label 'master' }
            steps {
                script {
                    def version = readFile(file: '.build-version')
                    println(version)
                    sh "docker build -t ${REGESTRY_URL}/${DOCKER_IMAGE_NAME}:${TAG}-${version} src/"
                }
            }
        }
 
        stage('Push image') {
            agent { label 'master' }
            steps {
                script {
                    def version = readFile(file: '.build-version')
                    println(version)
                    sh "docker push ${REGESTRY_URL}/${DOCKER_IMAGE_NAME}:${TAG}-${version}"
                }
            }
        }
    }
}
