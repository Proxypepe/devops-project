pipeline {
    agent none

    environment {   
        REGESTRY_URL = "dockerregistry.local:5000"
        DOCKER_IMAGE_NAME = "flask-app-devops"
        TAG = "monitoring"
    }

    stages {
        

        stage("Test configurations") {
            agent { label 'slave' }
            steps {
                sh 'ansible-lint ansible/'
            }
        }

        stage("Working with code") {
            agent { label 'slave' }
            steps {
                sh 'flake8 src/'
            }     
        }

        stage('Build image') {
            agent { label 'master' }
            steps {
                sh "docker build -t ${REGESTRY_URL}/${DOCKER_IMAGE_NAME}:${TAG} src/"
            }
        }
 
        stage('Push image') {
            agent { label 'master' }
            steps {
                script {
                    def workspace = pwd()
                    def version = readFile "${workspace}/.build-version"
                    sh 'echo path: ${workspace}'
                    sh 'echo "version: ${version}"'
                }
            }
        }
    }
}
